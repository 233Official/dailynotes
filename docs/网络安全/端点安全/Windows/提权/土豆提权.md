# 土豆提权

- [土豆提权](#土豆提权)
  - [概述](#概述)
  - [HotPotato](#hotpotato)
    - [影响范围](#影响范围)
    - [原理](#原理)
    - [利用过程](#利用过程)
  - [BadPotato](#badpotato)
    - [使用方法](#使用方法)

---

## 概述

|     工具      |        提权原理        |                适配系统版本                 | 是否依赖网络 |
| :-----------: | :--------------------: | :-----------------------------------------: | :----------: |
|  Hot Potato   |       NTLM 中继        | Windows 7/8/10(早期版本) / Server 2008/2012 |      是      |
|     Tater     |  NTLM 中继（改进版）   |        Windows 7 / Server 2008/2012         |      是      |
|  JuicyPotato  |  COM 对象 Token 劫持   |        Windows 7 / Server 2008/2016         |      否      |
|  SweetPotato  | 改进的 COM Token 劫持  |    Windows 10 / Server 2016/2019（部分）    |      否      |
|  RoguePotato  |  RPC + COM Token 劫持  |          Windows 10 / Server 2019           |      否      |
| PrintSpoofer  | Print Spooler 服务漏洞 |          Windows 10 / Server 2019           |      否      |
| Rotten Potato |                        |                                             |              |

1. **Hot Potato (2016)**

   - **背景**: Hot Potato 是最早的 “Potato” 系列工具之一，由 Casey Smith 等人开发，基于当时 Windows 系统中存在的 NTLM 中继攻击技术
   - **核心原理**: 通过劫持本地网络流量，利用 DNS 欺骗和 NTLM 身份验证请求中继，将 SYSTEM 权限的服务身份验证请求重定向到攻击者控制的恶意服务
   - **支持版本**: Windows 7/8/10(早期版本) / Server 2008/2012

2. **Tater (2016)**

   - **背景**: Tater 是 Hot Potato 的改进版本，由 FoxGlove Security 推出。它修复了一些 Hot Potato 的运行稳定性问题
   - **改进点**: 
     - 增强兼容性，支持更多的 Windows 系统
     - 提高攻击稳定性，减少因环境差异导致的失败
     - **支持版本**: 与 Hot Potato 类似，但适配性更强

3. **JuicyPotato (2018)**

   - **背景**: JuicyPotato 是 Potato 家族中最知名的工具之一，由 `@_decoder` 和 `Gabetm` 发布。它脱离了 NTLM 中继的原始思路，改用 Windows COM 组件和 Token Manipulation 漏洞进行提权
   - **核心原理**:
     1. 利用 Windows COM 服务（如 DCOM 或 BITS）
     2. 请求 SYSTEM 权限的 COM 对象
     3. 劫持令牌执行代码
   - **支持版本**:

4. **SweetPotato (2019)**
   - **背景**: SweetPotato 是 JuicyPotato 的改进版本，针对 JuicyPotato 在某些系统上失效的问题进行了优化。
   - **改进点**: 支持 Windows 10 和 Windows Server 2019（部分版本）
   - 增加对不同 COM 接口的利用（例如 PrintNotify）
   - **支持版本**: Windows 10（部分早期版本）Windows Server 2016/2019（特定版本）


---


## HotPotato

> [Potato提权合集 / 奇安信攻防社区](https://forum.butian.net/share/860)
>
> [Hot Potato – Windows Privilege Escalation / @breenmachine](https://foxglovesecurity.com/2016/01/16/hot-potato/)
>
> [015. Hot Potato | Windows Privilege Escalation / root@kali / Youtube](https://www.youtube.com/watch?v=pOuhpcG87G4)
>
> [域渗透之热土豆的提权-创建新用户 / CSDN](https://blog.csdn.net/weixin_45612728/article/details/123010630)

HotPotato 利用 Windows 中的已知问题在默认配置中获得本地权限提升

> 已知问题 -> NTLM 中继(特别是 HTTP->SMB 中继)和 NBNS 欺骗

攻击者可以在安装了Windows操作系统的工作站中将自己的低权限提升至`NT AUTHORITY\SYSTEM`

---

### 影响范围

Windows 7、8、10、Server 2008 和 Server 2012

---

### 原理



---

### 利用过程

clone [HotPotato仓库](https://github.com/foxglovesec/Potato) 到靶机，进入 `source\Potato\Potato\bin\Release` 目录可以看到 `Potato.exe`

![image-20241212164455685](http://cdn.ayusummer233.top/DailyNotes/202412121644967.png)

准备一个上线马执行如下命令

```cmd
Potato.exe -ip [本机ip] -cmd "命令行（可执行程序路径）" -enable_httpserver true -enable_defender true -enable_spoof true -enable_exhaust true
```

![image-20241212164640183](http://cdn.ayusummer233.top/DailyNotes/202412121646221.png)

---

> TODO: 需要一个成功利用的截图

![image-20241212150813472](http://cdn.ayusummer233.top/DailyNotes/202412121508790.png)



---


## BadPotato

> [BadPotato / BeichenDream / Github ](https://github.com/BeichenDream/BadPotato)
>
> [Atomic Test #4 - Bad Potato / Atomic Red Team](https://www.atomicredteam.io/atomic-red-team/atomics/T1134.001#atomic-test-4---bad-potato)
>
> [Potato提权(原理简述) / 虚构之人 / CSDN](https://blog.csdn.net/qq_18811919/article/details/135290115)
>
> [PrintSpoofer - Abusing Impersonation Privileges on Windows 10 and Server 2019 / itm4n's blog itm4n 的博客](https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/)

- 目标系统
  - Windows 2012-2019
  - Windows 8-10

- 效果图：

  ![image-20241211141431814](http://cdn.ayusummer233.top/DailyNotes/202412111414916.png)

通过 Printer Bug 利用SpoolSample,打印机窃取system Token,使用 Print Spooler 服务公开的函数 RpcRemoteFindFirstPrinterChangeNotificationEx 向打印客户端发送更改通知，通知通过RPC匿名管道， RPC 接口是通过命名管道公开的：``\\.\pipe\spoolss` 的正常情况下UNC路径会被占用使用\进行分割,使用/通过路径验证检查比如 `\\DESKTOP-ASD29\abc\pipe\spoolss` 被使用验证路径失败改为 `\DESKTOP-ASD29/pipe/abc` 则会自动转换为 `\\\DESKTOP-ASD29\pipe\abc\pipe\spoolss` 转为一个新有效的路径并绕过路径检查获取SpoolSample系统Token获取模拟令牌进行提权。

---

### 使用方法

clone [BadPotato 仓库源码](https://github.com/BeichenDream/BadPotato) 到本地使用 VisualStudio 打开项目并生成可执行程序

![image-20241211141703735](http://cdn.ayusummer233.top/DailyNotes/202412111417816.png)

> 提示缺失 .NETFramework 4.0 开发工具包的话可以参阅 [此方式](../../../../Language/CSharp/csharp.md#visual-studio-2022-安装net旧版本net-framework40) 解决

然后在项目目录 `bin/Debug` 中可以看到生成的 exe 文件：

![image-20241211141923486](http://cdn.ayusummer233.top/DailyNotes/202412111419549.png)

将文件复制到靶机执行 `BadPotato.exe [命令行]` 即可使用，例如：

![image-20241211142017710](http://cdn.ayusummer233.top/DailyNotes/202412111420806.png)

---
